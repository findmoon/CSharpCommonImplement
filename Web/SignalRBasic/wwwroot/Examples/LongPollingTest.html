<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
</head>
<body>
    <button id="btnStart" type="button">开始LongPolling</button>
    <span id="result" style="color:red;font-weight:bolder;"></span>
    <br>
    <br>
    <br><br>
    <button id="btnReset" type="button">重置</button>
    <script>
        async function fetchWithTimeout(resource, options = {}) {
                const { timeout = 10000 } = options;

                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                const response = await fetch(resource, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(id);
                return response;
            }
        window.onload=()=>{
            const resultDiv = document.getElementById("result");

            async function longPolling(id) {
                try {
                    const response = await fetchWithTimeout('/api/DemoTest/LongPollingTest_GetCount/' + id, {
                        timeout: 1500  // 测试用，超时时间
                    });
                    if (response.status === 200) {
                        const result = await response.json();
                        let txt = `id(${result.id})-count(${result.count})`
                        if (result.finished) {
                            resultDiv.innerHTML = txt + ",已结束";
                        }
                        else{                        
                            resultDiv.innerHTML = txt;
                        }
                    }
                    else{
                        // 其他状态码，比如服务器错误、400错误，可以考虑取消请求
                        console.log(response.status + '发生了异常，请确认问题');
                    }
                } catch (error) {
                    // Timeouts if the request takes longer than 6 seconds
                    console.log(error.name === 'AbortError');
                }

                // 成功或失败，继续下一次请求
                // 其他状态码，比如服务器错误、400错误，可以考虑取消请求
                longPolling((parseInt(1 + 20 * Math.random())));
            }
        

            document.getElementById('btnStart').addEventListener('click', () => {
                longPolling((parseInt(1 + 20 * Math.random())));
            });

            // 重置
            document.getElementById('btnReset').addEventListener('click', () => {
                fetch('/api/DemoTest/ResetCount', {
                    method: 'PUT', // *GET, POST, PUT, DELETE, etc.
                    })
                    .then(res=>{
                        console.log(res);
                        // return res.json();
                        return res.text();
                    })
                    .then(obj=>console.log(`重置结束 ${obj}.`));
            });
        }
</script>
</body>
</html>