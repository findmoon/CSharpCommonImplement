**C# ä» UTF-8 æµä¸­è¯»å–å­—ç¬¦ä¸²çš„æ­£ç¡®æ–¹æ³•-é—®é¢˜å’Œè§£å†³æ–¹æ³•**

[toc]

> è¿™ç¯‡çš„èµ·å› æ¥è‡ª [C# ä» UTF-8 æµä¸­è¯»å–å­—ç¬¦ä¸²çš„æ­£ç¡®æ–¹æ³•](https://blog.csdn.net/wanghao72214/article/details/121460606) çš„ä»‹ç»ã€‚
> 
> é€šè¿‡ Stream è¯»å– UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²æ—¶ï¼ˆä»»ä½•å¤šå­—èŠ‚ç¼–ç éƒ½ä¸€æ ·æœ‰è¿™ä¸ªé—®é¢˜ï¼‰ï¼Œå¾ˆå¤§æ¦‚ç‡ä¼šå‡ºç°è¯»å–åˆ°å­—èŠ‚æ•°é‡ï¼ˆæˆ–å­—èŠ‚ä½ç½®ï¼‰ï¼Œå¹¶ä¸æ˜¯æ­£å¥½ç­‰äºå­—èŠ‚ç¼–ç æ­£ç¡®ç¼–ç é•¿åº¦ã€‚
> 
> æ¯”å¦‚ï¼ŒUTF-8 ä½¿ç”¨ 1 åˆ° 4 ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºä¸€ä¸ª Unicode å­—ç¬¦ï¼Œå¦‚æœè¯»å–åˆ°ç¼“å†²åŒºçš„å­—èŠ‚ä¸æ˜¯å®Œæ•´çš„UTF-8å­—ç¬¦ï¼Œé‚£ä¹ˆå°±æ²¡æ­£ç¡®è§£ç ä¸ºæ­£ç¡®çš„å­—ç¬¦ï¼Œå‡ºç°ä¹±ç å½¢å¼ï¼
> 
> æ–‡ä¸­ç»™å‡ºäº†ä¸¤ç§è§£å†³åŠæ³•ï¼š**1. è¯»å–å®Œå…¨éƒ¨çš„å­—èŠ‚æ•°æ®åï¼Œæ‰å°†æ€»çš„å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼›2. é€šè¿‡`StreamReader`ä½¿ç”¨æŒ‡å®šç¼–ç è¯»å–æ•´ä¸ªstreamæµæˆ–æ–‡ä»¶ã€‚**
> 
> æ­¤å¤–è¿˜æåˆ°ï¼Œ`System.Text.Decoder`ç±»æ­£ç¡®è§£ç ç¼“å†²åŒºå†…çš„å­—ç¬¦ï¼Œä½¿ç”¨`PipeReader`ã€`Rune`ç±»æ¥ä»¥å†…å­˜æ€§èƒ½ä¼˜åŒ–çš„æ–¹å¼è¯»å–æ•°æ®ã€‚æœªåšå…·ä½“ä»‹ç»ã€‚

> å…¶å®ï¼Œå…¶å®é™¤äº†ä¸Šé¢æåˆ°çš„æ–¹æ³•ï¼Œè¿˜æœ‰ä¸€ä¸ªæ›´ç®€æ´ã€æ›´å¥½ç”¨çš„è§£å†³åŠæ³•ï¼š
> 
> ä»¥ 4 çš„å€æ•° é•¿åº¦ä¸ºå•ä½ï¼Œè¯»å–streamæµçš„å­—èŠ‚ï¼Œè¿™æ ·å°±èƒ½ä¿è¯ è¯»å–åˆ°çš„éƒ½æ˜¯æ­£ç¡®ä½ç½®çš„UTF-8ç¼–ç å­—èŠ‚ï¼ˆå› ä¸ºå®ƒçš„èŒƒå›´å°±æ˜¯1-4ä¸ªå­—èŠ‚ï¼‰ã€‚ä¸ä¼šå‡ºç°æˆªæ–­çš„æƒ…å†µï¼


æˆ‘ä»¬ä¸‹é¢çš„ä»£ç æ˜¯ä»ä¸€ä¸ªæµ [stream](https://so.csdn.net/so/search?q=stream&spm=1001.2101.3001.7020) ä¸­è¯»å– UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²ã€‚æˆ‘ä»¬å¯ä»¥å…ˆè€ƒè™‘ä¸€ä¸‹å…¶ä¸­å­˜åœ¨çš„æ½œåœ¨é—®é¢˜ã€‚

```csharp
string ReadString(Stream stream)
{
    var sb = new StringBuilder();
    var buffer = new byte[4096];
    int readCount;
    while ((readCount = stream.Read(buffer)) > 0)
    {
        var s = Encoding.UTF8.GetString(buffer, 0, readCount);
        sb.Append(s);
    }

    return sb.ToString();
}
```

é—®é¢˜å‡ºåœ¨ï¼šæŸäº›æƒ…å†µä¸‹è¿”å›çš„å­—ç¬¦ä¸²ä¸ä¸åŸå§‹ç¼–ç çš„å­—ç¬¦ä¸²å¹¶ä¸åŒã€‚  
ä¾‹å¦‚ï¼Œç¬‘è„¸ç¬¦å·ğŸ˜Š æœ‰æ—¶ä¼šè¢«è§£ç ä¸º 4 ä¸ªæœªçŸ¥å­—ç¬¦ï¼š

```csharp
ç¼–ç å­—ç¬¦ä¸²: ğŸ˜Š
è§£ç å­—ç¬¦ä¸²: ????
```

æˆ‘ä»¬çŸ¥é“ï¼šUTF-8 å¯ä»¥ä½¿ç”¨ 1 åˆ° 4 ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºä¸€ä¸ª Unicode å­—ç¬¦ï¼Œæœ‰å…³å­—ç¬¦ä¸²ç¼–ç çš„çŸ¥è¯†å¯ä»¥å‚è€ƒ â€‹â€‹[å­—ç¬¦ç¼–ç â€‹â€‹â€‹](http://www.codebaoku.com/charset/charset-index.html) ä¸€æ–‡ã€‚

â€‹â€‹Stream.Readâ€‹â€‹â€‹ æ–¹æ³•å¯ä»¥æŠŠä» 1 åˆ°â€‹â€‹ messageBuffer.Lengthâ€‹â€‹â€‹ å­—èŠ‚è¿”å›ï¼Œè¿™æ„å‘³ç€ç¼“å†²åŒºå¯èƒ½åŒ…å«ä¸å®Œæ•´çš„ UTF-8 å­—ç¬¦ã€‚

ä¸€æ—¦ç¼“å†²åŒºä¸­çš„æœ€åä¸€ä¸ªå­—ç¬¦çš„ UTF-8 ç¼–ç ä¸å®Œæ•´ï¼Œé‚£ä¹ˆ â€‹â€‹Encoding.UTF8.GetStringâ€‹â€‹ å°±æ˜¯è½¬æ¢ä¸€ä¸ªæ— æ•ˆçš„ UTF-8 å­—ç¬¦ä¸²ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªæ— æ•ˆå­—ç¬¦ä¸²ï¼Œå› ä¸ºå®ƒæ— æ³•çŒœæµ‹ä¸¢å¤±çš„å­—èŠ‚ã€‚

æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹ä»£ç æ¼”ç¤ºä»¥ä¸Šè¡Œä¸ºï¼š

```csharp
var bytes = Encoding.UTF8.GetBytes("?");
// bytes = new byte[4] { 240, 159, 152, 138 }

var sb = new StringBuilder();
// æ¨¡æ‹Ÿé€ä¸ªå­—èŠ‚åœ°è¯»å–æ•°æ®æµ
for (var i = 0; i < bytes.Length; i++)
{
    sb.Append(Encoding.UTF8.GetString(bytes, i, 1));
}

Console.WriteLine(sb.ToString());
// "????" ä»£æ›¿äº† "ğŸ˜Š"

Encoding.UTF8.GetBytes(sb.ToString());
// new byte[12] { 239, 191, 189, 239, 191, 189, 239, 191, 189, 239, 191, 189 }
 
```

## å¦‚ä½•ä¿®å¤ä»£ç 

æœ‰å¤šç§æ–¹æ³•å¯ä»¥ä¿®å¤ä»£ç ã€‚  
ç¬¬ä¸€ç§æ–¹æ³•ï¼šåªæœ‰å½“ä½ å¾—åˆ°å…¨éƒ¨æ•°æ®æ—¶ï¼Œæ‰å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚

```csharp
string ReadString(Stream stream)
{
    using var ms = new MemoryStream();
    var buffer = new byte[4096];
    int readCount;
    while ((readCount = stream.Read(buffer)) > 0)
    {
        ms.Write(buffer, 0, readCount);
    }

    return Encoding.UTF8.GetString(ms.ToArray());
}
```

ç¬¬äºŒç§æ–¹æ³•ï¼šå¯ä»¥æŠŠæµåŒ…è¿›ä¸€ä¸ªå…·æœ‰æ­£ç¡®ç¼–ç çš„ StreamReader å¯¹è±¡ä¸­ã€‚

```csharp
string ReadString(Stream stream)
{
    using var sr = new StreamReader(stream, Encoding.UTF8);
    return sr.ReadToEnd();
}
```

å¦å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨System.Text.Decoderç±»æ¥æ­£ç¡®è§£ç ç¼“å†²åŒºå†…çš„å­—ç¬¦ã€‚åœ¨éœ€è¦æ€§èƒ½çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨PipeReaderã€Runeç±»æ¥ä»¥å†…å­˜ä¼˜åŒ–çš„æ–¹å¼è¯»å–æ•°æ®ã€‚

**å‚è€ƒèµ„æ–™ï¼š**

1. â€‹â€‹[å­—ç¬¦ç¼–ç â€‹ â€‹â€‹](http://www.codebaoku.com/charset/charset-index.html)
2. [C#æ•™ç¨‹â€‹](http://www.codebaoku.com/csharp/csharp-index.html)

