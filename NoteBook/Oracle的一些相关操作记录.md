**Oracle的一些相关操作记录**

[toc]

# 基础概念

一般Oracle数据库（Oracle Database）可以分为两部分，即实例（Instance）和数据库（Database）。
实例：是一个非固定的、基于内存的基本进程与内存结构。当服务器关闭后，实例也就不存在了。

数据库（Database）指的是固定的、基于磁盘的数据文件、控制文件、日志文件、参数文件和归档日志文件等。

一般情况下，Oracle数据库都是一个数据库对应一个实例。



# system、sys用户

> 一个数据库实例对应不同的(独立的)system、sys用户。因此，在创建数据库实例时，每次都需要指定system、sys的口令。

system是数据库内置的一个普通管理员，你手工创建的任何用户在被授予dba角色后都跟这个用户差不多。

sys用数据库的超级用户，数据库内很多重要的东西（数据字典表、内置包、静态数据字典视图等）都属于这个用户，sys用户必须以sysdba身份登录。

> 所有oracle的数据字典的基表和视图都存放在sys用户中，这些基表和视图对于oracle的运行是至关重要的，由数据库自己维护，任何用户都不能手动更改。
> 
> sys用户拥有dba，sysdba，sysoper等角色或权限，是oracle权限最高的用户。

> system用户用于存放次一级的内部数据，如oracle的一些特性或工具的管理信息。system用户拥有普通dba角色权限。

system用户以sysdba身份登录时就是sys，准确地说，任何用户以sysdba身份登录时都是sys（可以登陆后执行show user验证。）

`as sysdba` 就是以`sysdba`登录。

oracle登录身份有三种：

- normal 普通身份
- sysdba 系统管理员身份
- sysoper 系统操作员身份

每种身份对应不同的权限：

sysdba权限：

● 启动和关闭操作
● 更改数据库状态为打开/装载/备份，更改字符集
● 创建数据库
● 创建服务器参数文件spfile
● 日志归档和恢复
● 包含了“会话权限”权限

sysoper权限：

● 启动和关闭操作
● 更改数据库状态为打开/装载/备份
● 创建服务器参数文件spfile
● 日志归档和恢复
● 包含了“会话权限”权限
 
# 用户管理

## 创建用户

```sql
create user user_name identified by password;
```

## 修改用户

```sql
alter user user_name identified by password;
```

## 删除用户

```sql
drop user user_name;
```

若用户拥有对象，则不能直接删除，否则将返回一个错误值。指定关键字`cascade`,可删除用户所有的对象，然后再删除用户。

```sql
drop user user_name cascade;
```

## 锁定和解锁用户

```sql
alter user user_name account lock;


alter user user_name account unlock;
```

# 角色及授权

oracle为兼容以前版本，提供三种标准角色（role）：connect、resource和dba.

## connect role(连接角色)

临时用户，特指不需要建表的用户，通常只赋予他们connect role。

connect使用oracle简单权限，这种权限只对其他用户的表有访问权限，包括select/insert/update和delete等。

拥有 connect role 的用户还能够创建表、视图、序列（sequence）、簇（cluster）、同义词(synonym)、回话（session）和其他数据的链接（link）

## resource role(资源角色)

更可靠和正式的数据库用户可以授予resource role。

resource提供给用户另外的权限以创建他们自己的表、序列、过程(procedure)、触发器(trigger)、索引(index)和簇(cluster)。

##  dba role(数据库管理员角色)

dba role拥有所有的系统权限。包括无限制的空间限额和给其他用户授予各种权限的能力。

## 授权和撤销权限

```cs
grant connect, resource to user_name;
```

```sql
revoke connect, resource from user_name;
```

## 自定义角色

除了三种系统角色----connect、resource和dba，用户还可以在oracle创建自己的role。

用户创建的role可以由表或系统权限或两者的组合构成。为了创建role，用户必须具有create role系统权限。

1. 创建角色

语法： create role 角色名;

例子： create role testRole;

2. 授权角色

语法： grant select on class to 角色名;

列子： grant select on class to testRole;

注：现在，拥有testRole角色的所有用户都具有对class表的select查询权限

3. 删除角色

语法： drop role 角色名;

例子： drop role testRole;

注：与testRole角色相关的权限将从数据库全部删除

# SQL Plus登陆连接数据库

## SQL Plus登陆本地Oracle

登陆本地的Oracle，默认不需要安装Client，只有在客户端（其他电脑）连接Oracle数据库服务器时，才需要安装Oracle。

SQL Plus登陆Oracle，即使不连接任何数据库，至少也应保证Oracle上创建有一个数据库实例（未严格测试，但是如果登陆不上，可以使用`DBCA`随便创建个数据库再登陆测试）

## 以DBA权限登陆（不连接数据库）

### 方式一

```sh
sqlplus /nolog
```

```sh
conn sys/admin as sysdba
```

### 方式二

```sh
sqlplus sys/admin as sysdba
```

### 方式三

`sqlplus / as sysdba` 或 `conn / as sysdba` 不指定用户名密码作为`sysdba`登陆的方式，使用的是windows系统认证。因此，要保证开启系统认证登陆。

# Windows下sqlplus / as sysdba登录出现ora-01017用户名/口令无效的问题

在Windows系统下的命令行工具中，使用 `sqlplus / as sysdba`（或`sqlplus /nolog`--`connect / as sysdba`） 登陆Oracle时报错“ORA-01017: 用户名/口令无效; 登录被拒绝”

```sh
> sqlplus /nolog

SQL*Plus: Release 19.0.0.0.0 - Production on 星期一 10月 17 15:32:12 2022
Version 19.3.0.0.0

Copyright (c) 1982, 2019, Oracle.  All rights reserved.

SQL> connect / as sysdba
ERROR:
ORA-01017: 用户名/口令无效; 登录被拒绝
```

```sh
> sqlplus / as sysdba

SQL*Plus: Release 19.0.0.0.0 - Production on 星期一 10月 17 15:37:28 2022
Version 19.3.0.0.0

Copyright (c) 1982, 2019, Oracle.  All rights reserved.

ERROR:
ORA-01017: 用户名/口令无效; 登录被拒绝
```

如果操作系统用户是`administrator`，已经是管理员权限，则，不存在权限不够的问题，应该就是操作系统认证的环节出现了问题，查看`sqlnet.ora`文件（Oracle软件根目录`product\11.2.0\dbhome_1\network\admin\`或安装包目录下`network\admin\`）。

但是，由于安装Oracle时，选择的是“仅设置软件”（“仅安装软件”）：

![](img/20221017165617.png)  

> “仅配置软件”表示仅仅将配置当前的安装软件，将当前安装包所在的Oracle软件配置，并不是完整意义上的Oracle数据库（即使后面创建了数据库实例）
> 
> 创建和配置单实例数据库的作用在于“创建启动数据库”：
> 
> ![](img/20221017172619.png)  
>
> 而且，对于软件来说，似乎解压后的安装包，在安装后，是作为Oracle软件存在的（具体不太清楚）
> 
> ![](img/20221017173117.png)  

在Oracle安装包中`network\admin\`下的`sqlnet.ora`文件中，可以看到其内容：

```ini
# sqlnet.ora Network Configuration File: D:\download\Oracle\WINDOWS.X64_193000_db_home\NETWORK\ADMIN\sqlnet.ora
# Generated by Oracle configuration tools.

# This file is actually generated by netca. But if customers choose to 
# install "Software Only", this file wont exist and without the native 
# authentication, they will not be able to connect to the database on NT.

SQLNET.AUTHENTICATION_SERVICES= (NTS)

NAMES.DIRECTORY_PATH= (TNSNAMES, ONAMES, HOSTNAME)
```

SQLNET.AUTHENTICATION_SERVICES有3个参数：

- SQLNET.AUTHENTICATION_SERVICES = (NONE) 关闭操作系统认证
- SQLNET.AUTHENTICATION_SERVICES = (ALL) 开启LINUX和AIX操作系统认证
- SQLNET.AUTHENTICATION_SERVICES = (NTS) 开启windows操作系统认证

> 似乎"Software Only时，无法使用本地系统认证登陆（即使后面创建了数据库）。

后面只能暂时卸载Oracle，重新安装时选择“创建并配置单实例数据库”。等待安装完成，直接使用`sqlplus / as sysdba`登陆成功。

```sh
> sqlplus / as sysdba

SQL*Plus: Release 19.0.0.0.0 - Production on 星期一 10月 17 17:56:57 2022
Version 19.3.0.0.0

Copyright (c) 1982, 2019, Oracle.  All rights reserved.


连接到:
Oracle Database 19c Standard Edition 2 Release 19.0.0.0.0 - Production
Version 19.3.0.0.0

SQL> exit
从 Oracle Database 19c Standard Edition 2 Release 19.0.0.0.0 - Production
Version 19.3.0.0.0 断开
```

> Oracle 19c相关配置文件比如`sqlnet.ora`、监听文件`listener.ora`、实例数据库配置文件`tnsnames.ora`等，在安装完成后，都位于原安装包所在路径下的`network\admin\`中。
> 
> 也就是，安装包原文件已经作为Oracle软件被配置和使用，和之前的版本有所不同。

# oracle 查看用户名

## 查看当前用户名

```sql
show user;
select user from dual;
```

## oracle 查看所有用户名

```sql
select * from all_users;
```

# 参考

- [Oracle内置账户sys/system详解，角色normal/sysdba/sysoper详解及创建用户、角色、授权](https://blog.csdn.net/wqh0830/article/details/87874380)
- [windows平台 sqlplus / as sysdba登录出现ora-01017错误](https://blog.csdn.net/m0_37625564/article/details/112920445)